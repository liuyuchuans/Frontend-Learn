<!DOCTYPE html>
<html>
<head>
    <title>hello world</title>
    <style>
        #main-page{
            width: 100%;
            overflow: hidden;
        }
        #main-page::after{
            clear: both;
        }
        #main-left{
            width: 30%;
            float: left;
        }
        #main-right{
            width: 70%;
            float: right;
        }
        #user-list{
            width: 300px;
            padding: 0px;
            margin: 0px;
        }
        
        #user-list li{
            padding: 2.5px 10px;
            border: 1px #ccc solid;
            list-style: none;
            margin-bottom: 5px;
            background-color:azure;
        }

        #user-list li dl{
            overflow: hidden;
        }

        #user-list li dl dd{
            float: left;
        }


    </style>
    <script src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.js"></script>
    <script src="//cdn.bootcdn.net/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
</head>
<body>
    
<div id="main-page">

    <div id="main-left">
        <div id="me">
            hello
        </div>
        <div class='user-list'>
            <ul id="user-list">
                <li id="user-test">
                    <dl>
                        <dt>User A</dt>
                        <dd><button class="call">发起通话</button></dd>
                        <dd>私聊</dd>
                     </dl>
                </li>
                <li>User B</li>
                <li>User C</li>
            </ul>
        </div>

    </div>
    <div id="main-right">
        <video autoplay controls id="video-local"></video>

        <video autoplay controls id="video-remote"></video>
    </div>


</div>


</body>
<script>
    //封装一部分函数
    function getUserMedia(constrains, success, error) {
        if (navigator.mediaDevices.getUserMedia) {
            //最新标准API
            promise = navigator.mediaDevices.getUserMedia(constrains).then(success).catch(error);
        } else if (navigator.webkitGetUserMedia) {
            //webkit内核浏览器
            promise = navigator.webkitGetUserMedia(constrains).then(success).catch(error);
        } else if (navigator.mozGetUserMedia) {
            //Firefox浏览器
            promise = navagator.mozGetUserMedia(constrains).then(success).catch(error);
        } else if (navigator.getUserMedia) {
            //旧版API
            promise = navigator.getUserMedia(constrains).then(success).catch(error);
        }
    }

    function canGetUserMediaUse() {
        return !!(navigator.mediaDevices.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
    }


    const socket = io('//');
    var socketID = 0;
    var currentConnect = 0;

    //中转服务器
    const iceServer = {
        iceServers: [{   urls: [ "stun:ss-turn1.xirsys.com" ]}, {   username: "CEqIDkX5f51sbm7-pXxJVXePoMk_WB7w2J5eu0Bd00YpiONHlLHrwSb7hRMDDrqGAAAAAF_OT9V0dWR1d2Vi",   credential: "446118be-38a4-11eb-9ece-0242ac140004",   urls: [       "turn:ss-turn1.xirsys.com:80?transport=udp",       "turn:ss-turn1.xirsys.com:3478?transport=udp"   ]}]
    };

    const localVideoElm = document.getElementById('video-local');

    var pc = [];
    
    function init(parterID, createOffer){
        pc[parterID] = new RTCPeerConnection(iceServer);

        //尝试刷新本地摄像头
    
    
        //是否发起连接
        if(createOffer){
            //
        }

        //监听事件
        pc[parterID].onicecandidate = ( { candidate } ) => {
            //请注意，当检测到协议结束时candidate 属性为 null.
            socket.emit( 'ice candidates', { candidate: candidate, to: partnerName, sender: socketID } );
        };

        //当有新的流添加进来时 跟 addtrack 相关
        pc[parterID].ontrack = ( event ) => {
            let stream = event.streams[0];
            console.log("stream add:" + stream);
        }

        //当状态改变时
        pc[parterID].onconnectionstatechange = ( d ) => {
            console.log(parterID + '  :' + pc[parterID].iceConnectionState);
            switch ( pc[partnerName].iceConnectionState ) {
                case "connected":
                    // The connection has become fully connected
                    console.log( partnerName + ': connect');
                    break;
                case 'disconnected':
                case 'failed':
                    //h.closeVideo( partnerName );
                    break;

                case 'closed':
                    //h.closeVideo( partnerName );
                    break;
            }
        }

        //to notify it that its signaling state, as indicated by the signalingState property, has changed.
        pc[parterID].onsignalingstatechange = ( d ) => {
            switch ( pc[parterID].signalingState ) {
                    case "stable":
                        console.log("ICE negotiation complete");
                        break;
                    case 'closed':
                        console.log( "Signalling state is 'closed'" );
                        //h.closeVideo( partnerName );
                        break;
                }
        }
    }


    $(document).ready(function(){
        // console.log(localVideoElm.attr('data-test'))
        console.log(canGetUserMediaUse())

        //下面的函数需要封装
        if(canGetUserMediaUse()){
            getUserMedia({
                video : true,
                audio: false
            },(stream) => {
                //console.log(stream)
                //这是原生dom的写法
                localVideoElm.srcObject = stream;
                $(localVideoElm).width(800);

            },(err) => {
                console.log("访问用户媒体设备失败：", err.name, err.message);
            })
        } else {
            alert('您的浏览器不兼容，建议安装最新版Chrome');
        }

        //监听加入
        socket.on('connect', () => {
            socketID = socket.id;//socket.io.engine.id;
            console.log('hello local user: ' + socket.id);
            $('#me').text('hello ' + socket.id);

            //加入时候向服务器发送订阅/注册?
            socket.emit('new user greet', {msg : 'hello'});
            
            socket.on('need connect', (data) => {
                console.log('someone need connect' + data.msg);
                console.log(data.sender);
                let li = $('<li></li>').text(data.sender).attr('user-id', data.sender);
                //$('#user-list').append('<li>' + data.sender + '</li>');
                $('#user-list').append(li);

                $('#user-test').attr('user-id', data.sender)
                $('#user-test button[class="call"]').click(function(){
                    console.log($(this).parent().parent().parent().attr('user-id'))
                })

                socket.emit('ok we connect', { sender: socketID, receiver: data.sender});

                currentConnect++;

            })

            socket.on('user disconnected', (user) => {
                currentConnect
                console.log('user disconnected ' + user)
                //console.log('disconnect' +  $('#user-list li[user-id="' + user + '"]').text())
                $('#user-list li[user-id="' + user + '"]').remove();

                if(currentConnect > 0)
                    currentConnect--;
            })

            socket.on('ok we connect', (data) => {
                console.log('ok we connect ' + data.sender );
                let li = $('<li></li>').text(data.sender).attr('user-id', data.sender);
                $('#user-list').append(li);

                currentConnect++;
            })

        });

    });
</script>
</html>